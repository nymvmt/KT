<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메이플스토리 무기상점</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <header class="header">
            <h1><i class="fas fa-store"></i> 메이플스토리 무기상점</h1>
            <p>아이템 구매, 판매, 강화를 한 곳에서</p>
        </header>

        <!-- 네비게이션 -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="shop">
                <i class="fas fa-store"></i> 상점
            </button>
            <button class="nav-tab" data-tab="enhancement">
                <i class="fas fa-magic"></i> 강화
            </button>
            <button class="nav-tab" data-tab="trade">
                <i class="fas fa-exchange-alt"></i> 거래
            </button>
            <button class="nav-tab" data-tab="management">
                <i class="fas fa-cogs"></i> 관리
            </button>
        </nav>

        <!-- 상점 탭 -->
        <main class="tab-content active" id="shop-tab">
            <div class="shop-container">
                <div class="shop-header">
                    <h2><i class="fas fa-list"></i> 판매 아이템</h2>
                    <div class="shop-controls">
                        <select id="itemTypeFilter" onchange="filterItems()">
                            <option value="">전체 타입</option>
                            <option value="한손검">⚔️ 한손검</option>
                            <option value="활">🏹 활</option>
                            <option value="지팡이">🔮 지팡이</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadItems()">
                            <i class="fas fa-sync-alt"></i> 새로고침
                        </button>
                    </div>
                </div>
                <div class="items-grid" id="itemsList">
                    <!-- 아이템들이 여기에 표시됩니다 -->
                </div>
            </div>
        </main>

        <!-- 강화 탭 -->
        <main class="tab-content" id="enhancement-tab">
            <div class="enhancement-container">
                <div class="enhancement-left">
                    <h2><i class="fas fa-list"></i> 강화 가능한 아이템</h2>
                    <div class="items-grid" id="enhanceableItemsList">
                        <!-- 강화 가능한 아이템들이 여기에 표시됩니다 -->
                    </div>
                </div>
                <div class="enhancement-right">
                    <h2><i class="fas fa-cog"></i> 강화 설정</h2>
                    <div class="enhancement-form">
                        <div class="form-group">
                            <label>목표 강화 레벨:</label>
                            <select id="enhancementTarget" onchange="updateEnhancementInfo()">
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                        <div class="enhancement-info">
                            <div class="info-row">
                                <span>현재 레벨:</span>
                                <span id="currentLevel">-</span>
                            </div>
                            <div class="info-row">
                                <span>성공률:</span>
                                <span id="successRate">-</span>
                            </div>
                            <div class="info-row">
                                <span>강화 비용:</span>
                                <span id="enhancementCost">-</span>
                            </div>
                        </div>
                        <button class="btn btn-success" id="enhanceBtn" onclick="executeEnhancement()" disabled>
                            <i class="fas fa-magic"></i> 강화 실행
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- 거래 탭 -->
        <main class="tab-content" id="trade-tab">
            <div class="trade-container">
                <div class="trade-left">
                    <h2><i class="fas fa-shopping-cart"></i> 구매</h2>
                    <div class="items-list" id="shopItemsList">
                        <!-- 상점 아이템들이 여기에 표시됩니다 -->
                    </div>
                </div>
                <div class="trade-right">
                    <h2><i class="fas fa-tags"></i> 판매</h2>
                    <div class="items-list" id="playerItemsList">
                        <!-- 플레이어 아이템들이 여기에 표시됩니다 -->
                    </div>
                    <div class="trade-summary">
                        <h3>거래 정보</h3>
                        <div class="summary-item">
                            <span>선택된 아이템:</span>
                            <span id="selectedItemName">없음</span>
                        </div>
                        <div class="summary-item">
                            <span>거래 가격:</span>
                            <span id="tradePrice">0</span>
                        </div>
                        <div class="trade-actions">
                            <button class="btn btn-success" id="buyBtn" onclick="buyItem()" disabled>구매</button>
                            <button class="btn btn-warning" id="sellBtn" onclick="sellItem()" disabled>판매</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 관리 탭 -->
        <main class="tab-content" id="management-tab">
            <div class="management-container">
                <h2><i class="fas fa-plus-circle"></i> 아이템 추가</h2>
                <form class="add-item-form" id="itemForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>아이템 이름:</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label>가격:</label>
                            <input type="number" id="itemPrice" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>타입:</label>
                            <select id="itemType" required>
                                <option value="">선택하세요</option>
                                <option value="한손검">⚔️ 한손검</option>
                                <option value="활">🏹 활</option>
                                <option value="지팡이">🔮 지팡이</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>공격력:</label>
                            <input type="number" id="attackPower" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>설명:</label>
                        <textarea id="description" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> 아이템 추가
                    </button>
                </form>
            </div>
        </main>

        <!-- 메시지 알림 -->
        <div id="message" class="message"></div>
    </div>

    <script>
        // 전역 변수
        let items = [];
        let selectedEnhancementItem = null;
        let selectedTradeItem = null;

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            initTabs();
            loadItems();
            loadEnhanceableItems();
            loadShopItems();
            setupForm();
        });

        // 탭 초기화
        function initTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    
                    // 모든 탭 비활성화
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    // 선택된 탭 활성화
                    tab.classList.add('active');
                    document.getElementById(`${targetTab}-tab`).classList.add('active');
                });
            });
        }

        // 아이템 목록 로드
        async function loadItems() {
            try {
                showMessage('아이템을 불러오는 중...', 'loading');
                const response = await fetch('/api/maple-shop/items');
                if (response.ok) {
                    items = await response.json();
                    displayItems(items);
                    hideMessage();
                } else {
                    throw new Error('서버 오류');
                }
            } catch (error) {
                showMessage('아이템 목록을 불러오는데 실패했습니다.', 'error');
            }
        }

        // 아이템 표시
        function displayItems(itemsToShow) {
            const container = document.getElementById('itemsList');
            container.innerHTML = '';

            if (itemsToShow.length === 0) {
                container.innerHTML = '<p class="empty-message">아이템이 없습니다</p>';
                return;
            }

            itemsToShow.forEach(item => {
                const itemElement = createItemElement(item);
                container.appendChild(itemElement);
            });
        }

        // 아이템 요소 생성
        function createItemElement(item) {
            const element = document.createElement('div');
            element.className = 'item-card';
            
            const icon = getItemIcon(item.itemType);
            const rarityClass = getRarityClass(item.attackPower);

            element.innerHTML = `
                <div class="item-icon ${rarityClass}">${icon}</div>
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-type">${item.itemType}</div>
                    <div class="item-stats">
                        <span>공격력: ${item.attackPower}</span>
                        <span>레벨: ${item.requiredLevel}</span>
                    </div>
                </div>
                <div class="item-price">${item.price.toLocaleString()} 메소</div>
                <div class="item-actions">
                    <button class="btn btn-sm" onclick="editItem(${item.id})">수정</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">삭제</button>
                </div>
            `;

            return element;
        }

        // 아이템 필터링
        function filterItems() {
            const typeFilter = document.getElementById('itemTypeFilter').value;
            const filteredItems = typeFilter ? 
                items.filter(item => item.itemType === typeFilter) : 
                items;
            displayItems(filteredItems);
        }

        // 강화 가능한 아이템 로드
        async function loadEnhanceableItems() {
            try {
                const response = await fetch('/api/enhancement/items/1');
                if (response.ok) {
                    const enhanceableItems = await response.json();
                    displayEnhanceableItems(enhanceableItems);
                }
            } catch (error) {
                // 무시
            }
        }

        // 강화 가능한 아이템 표시
        function displayEnhanceableItems(items) {
            const container = document.getElementById('enhanceableItemsList');
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<p class="empty-message">강화 가능한 아이템이 없습니다</p>';
                return;
            }

            items.forEach(item => {
                const element = createEnhanceableItemElement(item);
                container.appendChild(element);
            });
        }

        // 강화 가능한 아이템 요소 생성
        function createEnhanceableItemElement(item) {
            const element = document.createElement('div');
            element.className = 'item-card enhanceable';
            element.onclick = () => selectItemForEnhancement(item);

            const icon = getItemIcon(item.itemType);
            const rarityClass = getRarityClass(item.attackPower);

            element.innerHTML = `
                <div class="item-icon ${rarityClass}">${icon}</div>
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-type">${item.itemType}</div>
                    <div class="item-level">강화 +${item.enhancementLevel || 0}</div>
                </div>
            `;

            return element;
        }

        // 강화용 아이템 선택
        function selectItemForEnhancement(item) {
            selectedEnhancementItem = item;
            updateEnhancementForm(item);
        }

        // 강화 폼 업데이트
        function updateEnhancementForm(item) {
            const currentLevel = item.enhancementLevel || 0;
            const maxLevel = 20;

            // 목표 레벨 옵션 생성
            const targetSelect = document.getElementById('enhancementTarget');
            targetSelect.innerHTML = '<option value="">선택하세요</option>';
            
            for (let i = currentLevel + 1; i <= maxLevel; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `+${i}`;
                targetSelect.appendChild(option);
            }

            // 정보 업데이트
            document.getElementById('currentLevel').textContent = `+${currentLevel}`;
            document.getElementById('successRate').textContent = '-';
            document.getElementById('enhancementCost').textContent = '-';
            document.getElementById('enhanceBtn').disabled = true;
        }

        // 강화 정보 업데이트
        async function updateEnhancementInfo() {
            const targetLevel = document.getElementById('enhancementTarget').value;
            if (!targetLevel || !selectedEnhancementItem) return;

            try {
                const response = await fetch(`/api/enhancement/info/${selectedEnhancementItem.id}?playerId=1`);
                if (response.ok) {
                    const info = await response.json();
                    document.getElementById('successRate').textContent = `${info.successRate}%`;
                    document.getElementById('enhancementCost').textContent = `${info.cost.toLocaleString()} 메소`;
                    document.getElementById('enhanceBtn').disabled = false;
                }
            } catch (error) {
                showMessage('강화 정보를 불러오는데 실패했습니다.', 'error');
            }
        }

        // 강화 실행
        async function executeEnhancement() {
            if (!selectedEnhancementItem) {
                showMessage('강화할 아이템을 선택하세요.', 'error');
                return;
            }

            const targetLevel = document.getElementById('enhancementTarget').value;
            if (!targetLevel) {
                showMessage('목표 강화 레벨을 선택하세요.', 'error');
                return;
            }

            try {
                showMessage('강화를 실행하는 중...', 'loading');
                const response = await fetch('/api/enhancement/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        itemId: selectedEnhancementItem.id,
                        playerId: 1,
                        currentLevel: selectedEnhancementItem.enhancementLevel || 0,
                        targetLevel: parseInt(targetLevel)
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(result.message, result.success ? 'success' : 'error');
                    loadEnhanceableItems();
                } else {
                    showMessage('강화 실행에 실패했습니다.', 'error');
                }
            } catch (error) {
                showMessage('강화 중 오류가 발생했습니다.', 'error');
            }
        }

        // 상점 아이템 로드
        async function loadShopItems() {
            try {
                const response = await fetch('/api/maple-shop/items');
                if (response.ok) {
                    const shopItems = await response.json();
                    displayShopItems(shopItems);
                }
            } catch (error) {
                // 무시
            }
        }

        // 상점 아이템 표시
        function displayShopItems(items) {
            const container = document.getElementById('shopItemsList');
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<p class="empty-message">판매 중인 아이템이 없습니다</p>';
                return;
            }

            items.forEach(item => {
                const element = createShopItemElement(item);
                container.appendChild(element);
            });
        }

        // 상점 아이템 요소 생성
        function createShopItemElement(item) {
            const element = document.createElement('div');
            element.className = 'item-card shop-item';
            element.onclick = () => selectItemForTrade(item, 'buy');

            const icon = getItemIcon(item.itemType);
            const rarityClass = getRarityClass(item.attackPower);

            element.innerHTML = `
                <div class="item-icon ${rarityClass}">${icon}</div>
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-type">${item.itemType}</div>
                    <div class="item-price">${item.price.toLocaleString()} 메소</div>
                </div>
            `;

            return element;
        }

        // 거래용 아이템 선택
        function selectItemForTrade(item, type) {
            selectedTradeItem = { ...item, tradeType: type };
            updateTradeInfo();
        }

        // 거래 정보 업데이트
        function updateTradeInfo() {
            if (!selectedTradeItem) return;

            document.getElementById('selectedItemName').textContent = selectedTradeItem.name;
            document.getElementById('tradePrice').textContent = selectedTradeItem.price.toLocaleString();

            const buyBtn = document.getElementById('buyBtn');
            const sellBtn = document.getElementById('sellBtn');

            if (selectedTradeItem.tradeType === 'buy') {
                buyBtn.disabled = false;
                sellBtn.disabled = true;
            } else {
                buyBtn.disabled = true;
                sellBtn.disabled = false;
            }
        }

        // 아이템 구매
        async function buyItem() {
            if (!selectedTradeItem || selectedTradeItem.tradeType !== 'buy') {
                showMessage('구매할 아이템을 선택하세요.', 'error');
                return;
            }

            if (!confirm(`"${selectedTradeItem.name}" 아이템을 ${selectedTradeItem.price.toLocaleString()} 메소에 구매하시겠습니까?`)) {
                return;
            }

            try {
                showMessage('아이템을 구매하는 중...', 'loading');
                // 실제 구매 API 호출 로직 추가 필요
                showMessage('아이템 구매가 완료되었습니다!', 'success');
                resetTrade();
            } catch (error) {
                showMessage('아이템 구매 중 오류가 발생했습니다.', 'error');
            }
        }

        // 아이템 판매
        async function sellItem() {
            if (!selectedTradeItem || selectedTradeItem.tradeType !== 'sell') {
                showMessage('판매할 아이템을 선택하세요.', 'error');
                return;
            }

            if (!confirm(`"${selectedTradeItem.name}" 아이템을 ${selectedTradeItem.price.toLocaleString()} 메소에 판매하시겠습니까?`)) {
                return;
            }

            try {
                showMessage('아이템을 판매하는 중...', 'loading');
                // 실제 판매 API 호출 로직 추가 필요
                showMessage('아이템 판매가 완료되었습니다!', 'success');
                resetTrade();
            } catch (error) {
                showMessage('아이템 판매 중 오류가 발생했습니다.', 'error');
            }
        }

        // 거래 초기화
        function resetTrade() {
            selectedTradeItem = null;
            document.getElementById('selectedItemName').textContent = '없음';
            document.getElementById('tradePrice').textContent = '0';
            document.getElementById('buyBtn').disabled = true;
            document.getElementById('sellBtn').disabled = true;
        }

        // 폼 설정
        function setupForm() {
            const form = document.getElementById('itemForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await addItem();
            });
        }

        // 아이템 추가
        async function addItem() {
            const formData = new FormData(document.getElementById('itemForm'));
            const itemData = {
                name: formData.get('itemName'),
                price: parseInt(formData.get('itemPrice')),
                itemType: formData.get('itemType'),
                attackPower: parseInt(formData.get('attackPower')),
                requiredLevel: 1,
                description: formData.get('description')
            };

            try {
                showMessage('아이템을 추가하는 중...', 'loading');
                const response = await fetch('/api/maple-shop/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });

                if (response.ok) {
                    showMessage('새로운 아이템이 추가되었습니다!', 'success');
                    document.getElementById('itemForm').reset();
                    loadItems();
                } else {
                    throw new Error('서버 오류');
                }
            } catch (error) {
                showMessage('아이템 추가에 실패했습니다.', 'error');
            }
        }

        // 아이템 수정
        function editItem(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            // 폼에 아이템 정보 채우기
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemType').value = item.itemType;
            document.getElementById('attackPower').value = item.attackPower;
            document.getElementById('description').value = item.description;

            // 관리 탭으로 이동
            document.querySelector('[data-tab="management"]').click();
        }

        // 아이템 삭제
        async function deleteItem(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            if (!confirm(`정말로 "${item.name}" 아이템을 삭제하시겠습니까?`)) {
                return;
            }

            try {
                showMessage('아이템을 삭제하는 중...', 'loading');
                const response = await fetch(`/api/maple-shop/items/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage(`"${item.name}" 아이템이 삭제되었습니다.`, 'success');
                    loadItems();
                } else {
                    throw new Error('서버 오류');
                }
            } catch (error) {
                showMessage('아이템 삭제에 실패했습니다.', 'error');
            }
        }

        // 유틸리티 함수들
        function getItemIcon(itemType) {
            const icons = {
                '한손검': '⚔️',
                '활': '🏹',
                '지팡이': '🔮'
            };
            return icons[itemType] || '📦';
        }

        function getRarityClass(attackPower) {
            if (attackPower >= 100) return 'legendary';
            if (attackPower >= 50) return 'epic';
            if (attackPower >= 20) return 'rare';
            return 'common';
        }

        function showMessage(message, type = 'info') {
            const messageEl = document.getElementById('message');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            messageEl.style.display = 'block';

            if (type !== 'loading') {
                setTimeout(() => hideMessage(), 5000);
            }
        }

        function hideMessage() {
            document.getElementById('message').style.display = 'none';
        }
    </script>
</body>
</html>

